{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import { Location, Visit, nextTick } from 'swup';\nimport Plugin from '@swup/plugin';\nimport OnDemandLiveRegion from 'on-demand-live-region';\n\nimport 'focus-options-polyfill';\n\nexport interface VisitA11y {\n\t/** How to announce the new content after it inserted */\n\tannounce: string | false | undefined;\n\t/** The element to focus after the content is replaced */\n\tfocus: string | false;\n}\n\ndeclare module 'swup' {\n\texport interface Visit {\n\t\t/** Accessibility settings for this visit */\n\t\ta11y: VisitA11y;\n\t}\n\texport interface HookDefinitions {\n\t\t'content:announce': undefined;\n\t\t'content:focus': undefined;\n\t}\n\texport interface Swup {\n\t\t/**\n\t\t * Announce something programmatically\n\t\t */\n\t\tannounce?: SwupA11yPlugin['announce'];\n\t}\n}\n\n/** Templates for announcements of the new page content. */\ntype Announcements = {\n\t/** How to announce the new page. */\n\tvisit: string;\n\t/** How to read a page url. Used as fallback if no heading was found. */\n\turl: string;\n};\n\n/** Translations of announcements, keyed by language. */\ntype AnnouncementTranslations = {\n\t[lang: string]: Announcements;\n};\n\ntype Options = {\n\t/** The selector for matching the main content area of the page. */\n\tcontentSelector: string;\n\t/** The selector for finding headings inside the main content area. */\n\theadingSelector: string;\n\t/** Whether to skip animations for users that prefer reduced motion. */\n\trespectReducedMotion: boolean;\n\t/** How to announce the new page title and url. */\n\tannouncements: Announcements | AnnouncementTranslations;\n\t/** Whether to focus elements with an [autofocus] attribute after navigation. */\n\tautofocus: boolean;\n\n\t/** How to announce the new page. @deprecated Use the `announcements` option.  */\n\tannouncementTemplate?: string;\n\t/** How to announce a url. @deprecated Use the `announcements` option. */\n\turlTemplate?: string;\n};\n\nexport default class SwupA11yPlugin extends Plugin {\n\tname = 'SwupA11yPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: Options = {\n\t\tcontentSelector: 'main',\n\t\theadingSelector: 'h1, h2, [role=heading]',\n\t\trespectReducedMotion: false,\n\t\tautofocus: false,\n\t\tannouncements: {\n\t\t\tvisit: 'Navigated to: {title}',\n\t\t\turl: 'New page at {url}'\n\t\t}\n\t};\n\n\toptions: Options;\n\n\tliveRegion: OnDemandLiveRegion;\n\n\tconstructor(options: Partial<Options> = {}) {\n\t\tsuper();\n\n\t\t// Merge deprecated announcement templates into new structure\n\t\toptions.announcements = {\n\t\t\t...this.defaults.announcements,\n\t\t\tvisit: options.announcementTemplate ?? String(this.defaults.announcements.visit),\n\t\t\turl: options.urlTemplate ?? String(this.defaults.announcements.url),\n\t\t\t...options.announcements\n\t\t};\n\n\t\t// Merge default options with user defined options\n\t\tthis.options = { ...this.defaults, ...options };\n\n\t\t// Create live region for announcing new page content\n\t\tthis.liveRegion = new OnDemandLiveRegion();\n\t}\n\n\tmount() {\n\t\t// Prepare new hooks\n\t\tthis.swup.hooks.create('content:announce');\n\t\tthis.swup.hooks.create('content:focus');\n\n\t\t// Prepare visit by adding a11y settings to visit object\n\t\tthis.before('visit:start', this.prepareVisit);\n\n\t\t// Mark page as busy during transitions\n\t\tthis.on('visit:start', this.markAsBusy);\n\t\tthis.on('visit:end', this.unmarkAsBusy);\n\n\t\t// Prepare announcement by reading new page heading\n\t\tthis.on('content:replace', this.prepareAnnouncement);\n\n\t\t// Announce new page and focus container after content is replaced\n\t\tthis.on('content:replace', this.handleNewPageContent);\n\n\t\t// Disable transition and scroll animations if user prefers reduced motion\n\t\tif (this.options.respectReducedMotion) {\n\t\t\tthis.before('visit:start', this.disableTransitionAnimations);\n\t\t\tthis.before('visit:start', this.disableScrollAnimations);\n\t\t\tthis.before('link:self', this.disableScrollAnimations);\n\t\t\tthis.before('link:anchor', this.disableScrollAnimations);\n\t\t}\n\n\t\t// Announce something programmatically\n\t\tthis.swup.announce = this.announce;\n\t}\n\n\tunmount() {\n\t\tthis.swup.announce = undefined;\n\t}\n\n\tmarkAsBusy() {\n\t\tdocument.documentElement.setAttribute('aria-busy', 'true');\n\t}\n\n\tunmarkAsBusy() {\n\t\tdocument.documentElement.removeAttribute('aria-busy');\n\t}\n\n\tprepareVisit(visit: Visit) {\n\t\tvisit.a11y = {\n\t\t\tannounce: undefined,\n\t\t\tfocus: this.options.contentSelector\n\t\t};\n\t}\n\n\tprepareAnnouncement(visit: Visit) {\n\t\t// Allow customizing announcement before this hook\n\t\tif (typeof visit.a11y.announce !== 'undefined') return;\n\n\t\tconst { contentSelector, headingSelector, announcements } = this.options;\n\t\tconst { href, url, pathname: path } = Location.fromUrl(window.location.href);\n\t\tconst lang = document.documentElement.lang || '*';\n\n\t\tconst templates: Announcements =\n\t\t\t(announcements as AnnouncementTranslations)[lang] ||\n\t\t\t(announcements as AnnouncementTranslations)['*'] ||\n\t\t\tannouncements;\n\t\tif (typeof templates !== 'object') return;\n\n\t\t// Look for first heading in content container\n\t\tconst heading = document.querySelector(`${contentSelector} ${headingSelector}`);\n\t\t// Get page title from aria attribute or text content\n\t\tlet title = heading?.getAttribute('aria-label') || heading?.textContent;\n\t\t// Fall back to document title, then url if no title was found\n\t\ttitle = title || document.title || this.parseTemplate(templates.url, { href, url, path });\n\t\t// Replace {variables} in template\n\t\tconst announcement = this.parseTemplate(templates.visit, { title, href, url, path });\n\n\t\tvisit.a11y.announce = announcement;\n\t}\n\n\tparseTemplate(str: string, replacements: Record<string, string>): string {\n\t\treturn Object.keys(replacements).reduce((str, key) => {\n\t\t\treturn str.replace(`{${key}}`, replacements[key] || '');\n\t\t}, str || '');\n\t}\n\n\thandleNewPageContent() {\n\t\t// We can't `await` nextTick() here because it would block ViewTransition callbacks\n\t\t// Apparently, during ViewTransition updates there is no microtask queue\n\t\tnextTick().then(async () => {\n\t\t\tthis.swup.hooks.call('content:announce', undefined, undefined, (visit) => {\n\t\t\t\tthis.announcePageName(visit);\n\t\t\t});\n\t\t\tthis.swup.hooks.call('content:focus', undefined, undefined, (visit) => {\n\t\t\t\tthis.focusPageContent(visit);\n\t\t\t});\n\t\t});\n\t}\n\n\tannouncePageName(visit: Visit) {\n\t\tif (visit.a11y.announce) {\n\t\t\tthis.liveRegion.say(visit.a11y.announce);\n\t\t}\n\t}\n\n\tannounce = (message: string): void => {\n\t\tthis.liveRegion.say(message);\n\t};\n\n\tasync focusPageContent(visit: Visit) {\n\t\t// Focus disabled for this visit?\n\t\tif (!visit.a11y.focus) return;\n\n\t\t// Found [autofocus] element?\n\t\tif (this.options.autofocus) {\n\t\t\tconst autofocusEl = this.getAutofocusElement();\n\t\t\tif (autofocusEl && autofocusEl !== document.activeElement) {\n\t\t\t\tthis.swup.hooks.once('visit:end', (v) => {\n\t\t\t\t\tif (v.id !== visit.id) return;\n\t\t\t\t\tautofocusEl.focus();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// Otherwise, find content container and focus it\n\t\tconst content = document.querySelector<HTMLElement>(visit.a11y.focus);\n\t\tif (content instanceof HTMLElement) {\n\t\t\tif (this.needsTabindex(content)) {\n\t\t\t\tcontent.setAttribute('tabindex', '-1');\n\t\t\t}\n\t\t\tcontent.focus({ preventScroll: true });\n\t\t}\n\t}\n\n\tgetAutofocusElement(): HTMLElement | undefined {\n\t\tconst focusEl = document.querySelector<HTMLElement>('body [autofocus]');\n\t\tif (focusEl && !focusEl.closest('inert, [aria-disabled], [aria-hidden=\"true\"]')) {\n\t\t\treturn focusEl;\n\t\t}\n\t}\n\n\tdisableTransitionAnimations(visit: Visit) {\n\t\tvisit.animation.animate = visit.animation.animate && this.shouldAnimate();\n\t}\n\n\tdisableScrollAnimations(visit: Visit) {\n\t\t// @ts-ignore: animate property is not defined unless Scroll Plugin installed\n\t\tvisit.scroll.animate = visit.scroll.animate && this.shouldAnimate();\n\t}\n\n\tshouldAnimate(): boolean {\n\t\treturn !window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n\t}\n\n\tneedsTabindex(el: HTMLElement): boolean {\n\t\treturn !el.matches('a, button, input, textarea, select, details, [tabindex]');\n\t}\n}\n"],"names":["Plugin","constructor","options","super","this","name","requires","swup","defaults","contentSelector","headingSelector","respectReducedMotion","autofocus","announcements","visit","url","liveRegion","announce","message","say","announcementTemplate","String","urlTemplate","OnDemandLiveRegion","mount","hooks","create","before","prepareVisit","on","markAsBusy","unmarkAsBusy","prepareAnnouncement","handleNewPageContent","disableTransitionAnimations","disableScrollAnimations","unmount","undefined","document","documentElement","setAttribute","removeAttribute","a11y","focus","href","pathname","path","Location","fromUrl","window","location","templates","lang","heading","querySelector","title","getAttribute","textContent","parseTemplate","announcement","str","replacements","Object","keys","reduce","key","replace","_this","nextTick","then","call","announcePageName","focusPageContent","Promise","resolve","e","reject","_this2","autofocusEl","getAutofocusElement","activeElement","once","v","id","content","HTMLElement","needsTabindex","preventScroll","focusEl","closest","animation","animate","shouldAnimate","scroll","matchMedia","matches","el"],"mappings":"wPA6DqB,cAAuBA,EAAAA,QAoB3CC,WAAAA,CAAYC,EAA4B,CAAA,GACvCC,QAAQC,KApBTC,KAAO,iBAEPC,KAAAA,SAAW,CAAEC,KAAM,OAEnBC,KAAAA,SAAoB,CACnBC,gBAAiB,OACjBC,gBAAiB,yBACjBC,sBAAsB,EACtBC,WAAW,EACXC,cAAe,CACdC,MAAO,wBACPC,IAAK,sBAIPb,KAAAA,aAEAc,EAAAA,KAAAA,uBAwHAC,SAAYC,IACXd,KAAKY,WAAWG,IAAID,EAAO,EAnH3BhB,EAAQW,cAAgB,IACpBT,KAAKI,SAASK,cACjBC,MAAOZ,EAAQkB,sBAAwBC,OAAOjB,KAAKI,SAASK,cAAcC,OAC1EC,IAAKb,EAAQoB,aAAeD,OAAOjB,KAAKI,SAASK,cAAcE,QAC5Db,EAAQW,eAIZT,KAAKF,QAAU,IAAKE,KAAKI,YAAaN,GAGtCE,KAAKY,WAAa,IAAIO,EAAAA,OACvB,CAEAC,KAAAA,GAECpB,KAAKG,KAAKkB,MAAMC,OAAO,oBACvBtB,KAAKG,KAAKkB,MAAMC,OAAO,iBAGvBtB,KAAKuB,OAAO,cAAevB,KAAKwB,cAGhCxB,KAAKyB,GAAG,cAAezB,KAAK0B,YAC5B1B,KAAKyB,GAAG,YAAazB,KAAK2B,cAG1B3B,KAAKyB,GAAG,kBAAmBzB,KAAK4B,qBAGhC5B,KAAKyB,GAAG,kBAAmBzB,KAAK6B,sBAG5B7B,KAAKF,QAAQS,uBAChBP,KAAKuB,OAAO,cAAevB,KAAK8B,6BAChC9B,KAAKuB,OAAO,cAAevB,KAAK+B,yBAChC/B,KAAKuB,OAAO,YAAavB,KAAK+B,yBAC9B/B,KAAKuB,OAAO,cAAevB,KAAK+B,0BAIjC/B,KAAKG,KAAKU,SAAWb,KAAKa,QAC3B,CAEAmB,OAAAA,GACChC,KAAKG,KAAKU,cAAWoB,CACtB,CAEAP,UAAAA,GACCQ,SAASC,gBAAgBC,aAAa,YAAa,OACpD,CAEAT,YAAAA,GACCO,SAASC,gBAAgBE,gBAAgB,YAC1C,CAEAb,YAAAA,CAAad,GACZA,EAAM4B,KAAO,CACZzB,cAAUoB,EACVM,MAAOvC,KAAKF,QAAQO,gBAEtB,CAEAuB,mBAAAA,CAAoBlB,GAEnB,QAAmC,IAAxBA,EAAM4B,KAAKzB,SAA0B,OAEhD,MAAMR,gBAAEA,EAAeC,gBAAEA,EAAeG,cAAEA,GAAkBT,KAAKF,SAC3D0C,KAAEA,EAAI7B,IAAEA,EAAK8B,SAAUC,GAASC,EAAAA,SAASC,QAAQC,OAAOC,SAASN,MAGjEO,EACJtC,EAHWyB,SAASC,gBAAgBa,MAAQ,MAI5CvC,EAA2C,MAC5CA,EACD,GAAyB,iBAAdsC,EAAwB,OAGnC,MAAME,EAAUf,SAASgB,cAAiB,GAAA7C,KAAmBC,KAE7D,IAAI6C,EAAQF,GAASG,aAAa,eAAiBH,GAASI,YAE5DF,EAAQA,GAASjB,SAASiB,OAASnD,KAAKsD,cAAcP,EAAUpC,IAAK,CAAE6B,OAAM7B,MAAK+B,SAElF,MAAMa,EAAevD,KAAKsD,cAAcP,EAAUrC,MAAO,CAAEyC,QAAOX,OAAM7B,MAAK+B,SAE7EhC,EAAM4B,KAAKzB,SAAW0C,CACvB,CAEAD,aAAAA,CAAcE,EAAaC,GAC1B,OAAOC,OAAOC,KAAKF,GAAcG,OAAO,CAACJ,EAAKK,IACtCL,EAAIM,YAAYD,KAAQJ,EAAaI,IAAQ,IAClDL,GAAO,GACX,CAEA3B,oBAAAA,SAAoBkC,EAIlB/D,KADDgE,EAAQA,WAAGC,KAAI,WAAA,IAMX,OALHF,EAAK5D,KAAKkB,MAAM6C,KAAK,wBAAoBjC,OAAWA,EAAYvB,IAC/DqD,EAAKI,iBAAiBzD,EAAK,GAE5BqD,EAAK5D,KAAKkB,MAAM6C,KAAK,qBAAiBjC,OAAWA,EAAYvB,IAC5DqD,EAAKK,iBAAiB1D,EAAK,GACzB2D,QAAAC,SACJ,CAAC,MAAAC,GAAAF,OAAAA,QAAAG,OAAAD,EACF,CAAA,EAAA,CAEAJ,gBAAAA,CAAiBzD,GACZA,EAAM4B,KAAKzB,UACdb,KAAKY,WAAWG,IAAIL,EAAM4B,KAAKzB,SAEjC,CAMMuD,gBAAAA,CAAiB1D,GAAY,IAAA+D,MAAAA,EAK9BzE,KAHJ,IAAKU,EAAM4B,KAAKC,MAAO,OAAA8B,QAAAC,UAGvB,GAAIG,EAAK3E,QAAQU,UAAW,CAC3B,MAAMkE,EAAcD,EAAKE,sBACzB,GAAID,GAAeA,IAAgBxC,SAAS0C,cAK3C,OAJAH,EAAKtE,KAAKkB,MAAMwD,KAAK,YAAcC,IAC9BA,EAAEC,KAAOrE,EAAMqE,IACnBL,EAAYnC,OAAK,GAElB8B,QAAAC,SAEF,CAGA,MAAMU,EAAU9C,SAASgB,cAA2BxC,EAAM4B,KAAKC,OAM9D,OALGyC,aAAmBC,cAClBR,EAAKS,cAAcF,IACtBA,EAAQ5C,aAAa,WAAY,MAElC4C,EAAQzC,MAAM,CAAE4C,eAAe,KAC/Bd,QAAAC,SACF,CAAC,MAAAC,GAAA,OAAAF,QAAAG,OAAAD,EAAA,CAAA,CAEDI,mBAAAA,GACC,MAAMS,EAAUlD,SAASgB,cAA2B,oBACpD,GAAIkC,IAAYA,EAAQC,QAAQ,gDAC/B,OAAOD,CAET,CAEAtD,2BAAAA,CAA4BpB,GAC3BA,EAAM4E,UAAUC,QAAU7E,EAAM4E,UAAUC,SAAWvF,KAAKwF,eAC3D,CAEAzD,uBAAAA,CAAwBrB,GAEvBA,EAAM+E,OAAOF,QAAU7E,EAAM+E,OAAOF,SAAWvF,KAAKwF,eACrD,CAEAA,aAAAA,GACC,OAAQ3C,OAAO6C,WAAW,oCAAoCC,OAC/D,CAEAT,aAAAA,CAAcU,GACb,OAAQA,EAAGD,QAAQ,0DACpB"}