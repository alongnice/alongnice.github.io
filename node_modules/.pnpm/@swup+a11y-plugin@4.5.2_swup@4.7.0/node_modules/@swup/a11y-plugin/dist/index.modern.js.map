{"version":3,"file":"index.modern.js","sources":["../src/index.ts"],"sourcesContent":["import { Location, Visit, nextTick } from 'swup';\nimport Plugin from '@swup/plugin';\nimport OnDemandLiveRegion from 'on-demand-live-region';\n\nimport 'focus-options-polyfill';\n\nexport interface VisitA11y {\n\t/** How to announce the new content after it inserted */\n\tannounce: string | false | undefined;\n\t/** The element to focus after the content is replaced */\n\tfocus: string | false;\n}\n\ndeclare module 'swup' {\n\texport interface Visit {\n\t\t/** Accessibility settings for this visit */\n\t\ta11y: VisitA11y;\n\t}\n\texport interface HookDefinitions {\n\t\t'content:announce': undefined;\n\t\t'content:focus': undefined;\n\t}\n\texport interface Swup {\n\t\t/**\n\t\t * Announce something programmatically\n\t\t */\n\t\tannounce?: SwupA11yPlugin['announce'];\n\t}\n}\n\n/** Templates for announcements of the new page content. */\ntype Announcements = {\n\t/** How to announce the new page. */\n\tvisit: string;\n\t/** How to read a page url. Used as fallback if no heading was found. */\n\turl: string;\n};\n\n/** Translations of announcements, keyed by language. */\ntype AnnouncementTranslations = {\n\t[lang: string]: Announcements;\n};\n\ntype Options = {\n\t/** The selector for matching the main content area of the page. */\n\tcontentSelector: string;\n\t/** The selector for finding headings inside the main content area. */\n\theadingSelector: string;\n\t/** Whether to skip animations for users that prefer reduced motion. */\n\trespectReducedMotion: boolean;\n\t/** How to announce the new page title and url. */\n\tannouncements: Announcements | AnnouncementTranslations;\n\t/** Whether to focus elements with an [autofocus] attribute after navigation. */\n\tautofocus: boolean;\n\n\t/** How to announce the new page. @deprecated Use the `announcements` option.  */\n\tannouncementTemplate?: string;\n\t/** How to announce a url. @deprecated Use the `announcements` option. */\n\turlTemplate?: string;\n};\n\nexport default class SwupA11yPlugin extends Plugin {\n\tname = 'SwupA11yPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: Options = {\n\t\tcontentSelector: 'main',\n\t\theadingSelector: 'h1, h2, [role=heading]',\n\t\trespectReducedMotion: false,\n\t\tautofocus: false,\n\t\tannouncements: {\n\t\t\tvisit: 'Navigated to: {title}',\n\t\t\turl: 'New page at {url}'\n\t\t}\n\t};\n\n\toptions: Options;\n\n\tliveRegion: OnDemandLiveRegion;\n\n\tconstructor(options: Partial<Options> = {}) {\n\t\tsuper();\n\n\t\t// Merge deprecated announcement templates into new structure\n\t\toptions.announcements = {\n\t\t\t...this.defaults.announcements,\n\t\t\tvisit: options.announcementTemplate ?? String(this.defaults.announcements.visit),\n\t\t\turl: options.urlTemplate ?? String(this.defaults.announcements.url),\n\t\t\t...options.announcements\n\t\t};\n\n\t\t// Merge default options with user defined options\n\t\tthis.options = { ...this.defaults, ...options };\n\n\t\t// Create live region for announcing new page content\n\t\tthis.liveRegion = new OnDemandLiveRegion();\n\t}\n\n\tmount() {\n\t\t// Prepare new hooks\n\t\tthis.swup.hooks.create('content:announce');\n\t\tthis.swup.hooks.create('content:focus');\n\n\t\t// Prepare visit by adding a11y settings to visit object\n\t\tthis.before('visit:start', this.prepareVisit);\n\n\t\t// Mark page as busy during transitions\n\t\tthis.on('visit:start', this.markAsBusy);\n\t\tthis.on('visit:end', this.unmarkAsBusy);\n\n\t\t// Prepare announcement by reading new page heading\n\t\tthis.on('content:replace', this.prepareAnnouncement);\n\n\t\t// Announce new page and focus container after content is replaced\n\t\tthis.on('content:replace', this.handleNewPageContent);\n\n\t\t// Disable transition and scroll animations if user prefers reduced motion\n\t\tif (this.options.respectReducedMotion) {\n\t\t\tthis.before('visit:start', this.disableTransitionAnimations);\n\t\t\tthis.before('visit:start', this.disableScrollAnimations);\n\t\t\tthis.before('link:self', this.disableScrollAnimations);\n\t\t\tthis.before('link:anchor', this.disableScrollAnimations);\n\t\t}\n\n\t\t// Announce something programmatically\n\t\tthis.swup.announce = this.announce;\n\t}\n\n\tunmount() {\n\t\tthis.swup.announce = undefined;\n\t}\n\n\tmarkAsBusy() {\n\t\tdocument.documentElement.setAttribute('aria-busy', 'true');\n\t}\n\n\tunmarkAsBusy() {\n\t\tdocument.documentElement.removeAttribute('aria-busy');\n\t}\n\n\tprepareVisit(visit: Visit) {\n\t\tvisit.a11y = {\n\t\t\tannounce: undefined,\n\t\t\tfocus: this.options.contentSelector\n\t\t};\n\t}\n\n\tprepareAnnouncement(visit: Visit) {\n\t\t// Allow customizing announcement before this hook\n\t\tif (typeof visit.a11y.announce !== 'undefined') return;\n\n\t\tconst { contentSelector, headingSelector, announcements } = this.options;\n\t\tconst { href, url, pathname: path } = Location.fromUrl(window.location.href);\n\t\tconst lang = document.documentElement.lang || '*';\n\n\t\tconst templates: Announcements =\n\t\t\t(announcements as AnnouncementTranslations)[lang] ||\n\t\t\t(announcements as AnnouncementTranslations)['*'] ||\n\t\t\tannouncements;\n\t\tif (typeof templates !== 'object') return;\n\n\t\t// Look for first heading in content container\n\t\tconst heading = document.querySelector(`${contentSelector} ${headingSelector}`);\n\t\t// Get page title from aria attribute or text content\n\t\tlet title = heading?.getAttribute('aria-label') || heading?.textContent;\n\t\t// Fall back to document title, then url if no title was found\n\t\ttitle = title || document.title || this.parseTemplate(templates.url, { href, url, path });\n\t\t// Replace {variables} in template\n\t\tconst announcement = this.parseTemplate(templates.visit, { title, href, url, path });\n\n\t\tvisit.a11y.announce = announcement;\n\t}\n\n\tparseTemplate(str: string, replacements: Record<string, string>): string {\n\t\treturn Object.keys(replacements).reduce((str, key) => {\n\t\t\treturn str.replace(`{${key}}`, replacements[key] || '');\n\t\t}, str || '');\n\t}\n\n\thandleNewPageContent() {\n\t\t// We can't `await` nextTick() here because it would block ViewTransition callbacks\n\t\t// Apparently, during ViewTransition updates there is no microtask queue\n\t\tnextTick().then(async () => {\n\t\t\tthis.swup.hooks.call('content:announce', undefined, undefined, (visit) => {\n\t\t\t\tthis.announcePageName(visit);\n\t\t\t});\n\t\t\tthis.swup.hooks.call('content:focus', undefined, undefined, (visit) => {\n\t\t\t\tthis.focusPageContent(visit);\n\t\t\t});\n\t\t});\n\t}\n\n\tannouncePageName(visit: Visit) {\n\t\tif (visit.a11y.announce) {\n\t\t\tthis.liveRegion.say(visit.a11y.announce);\n\t\t}\n\t}\n\n\tannounce = (message: string): void => {\n\t\tthis.liveRegion.say(message);\n\t};\n\n\tasync focusPageContent(visit: Visit) {\n\t\t// Focus disabled for this visit?\n\t\tif (!visit.a11y.focus) return;\n\n\t\t// Found [autofocus] element?\n\t\tif (this.options.autofocus) {\n\t\t\tconst autofocusEl = this.getAutofocusElement();\n\t\t\tif (autofocusEl && autofocusEl !== document.activeElement) {\n\t\t\t\tthis.swup.hooks.once('visit:end', (v) => {\n\t\t\t\t\tif (v.id !== visit.id) return;\n\t\t\t\t\tautofocusEl.focus();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// Otherwise, find content container and focus it\n\t\tconst content = document.querySelector<HTMLElement>(visit.a11y.focus);\n\t\tif (content instanceof HTMLElement) {\n\t\t\tif (this.needsTabindex(content)) {\n\t\t\t\tcontent.setAttribute('tabindex', '-1');\n\t\t\t}\n\t\t\tcontent.focus({ preventScroll: true });\n\t\t}\n\t}\n\n\tgetAutofocusElement(): HTMLElement | undefined {\n\t\tconst focusEl = document.querySelector<HTMLElement>('body [autofocus]');\n\t\tif (focusEl && !focusEl.closest('inert, [aria-disabled], [aria-hidden=\"true\"]')) {\n\t\t\treturn focusEl;\n\t\t}\n\t}\n\n\tdisableTransitionAnimations(visit: Visit) {\n\t\tvisit.animation.animate = visit.animation.animate && this.shouldAnimate();\n\t}\n\n\tdisableScrollAnimations(visit: Visit) {\n\t\t// @ts-ignore: animate property is not defined unless Scroll Plugin installed\n\t\tvisit.scroll.animate = visit.scroll.animate && this.shouldAnimate();\n\t}\n\n\tshouldAnimate(): boolean {\n\t\treturn !window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n\t}\n\n\tneedsTabindex(el: HTMLElement): boolean {\n\t\treturn !el.matches('a, button, input, textarea, select, details, [tabindex]');\n\t}\n}\n"],"names":["SwupA11yPlugin","Plugin","constructor","options","_options$announcement","_options$urlTemplate","super","this","name","requires","swup","defaults","contentSelector","headingSelector","respectReducedMotion","autofocus","announcements","visit","url","liveRegion","announce","message","say","_extends","announcementTemplate","String","urlTemplate","OnDemandLiveRegion","mount","hooks","create","before","prepareVisit","on","markAsBusy","unmarkAsBusy","prepareAnnouncement","handleNewPageContent","disableTransitionAnimations","disableScrollAnimations","unmount","undefined","document","documentElement","setAttribute","removeAttribute","a11y","focus","href","pathname","path","Location","fromUrl","window","location","templates","lang","heading","querySelector","title","getAttribute","textContent","parseTemplate","announcement","str","replacements","Object","keys","reduce","key","replace","_this","nextTick","then","async","call","announcePageName","focusPageContent","autofocusEl","getAutofocusElement","activeElement","once","v","id","content","HTMLElement","needsTabindex","preventScroll","focusEl","closest","animation","animate","shouldAnimate","scroll","matchMedia","matches","el"],"mappings":"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"}